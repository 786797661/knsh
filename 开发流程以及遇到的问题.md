## Kratos
### 创建项目
#### protoc
https://github.com/protocolbuffers/protobuf/releases/
下载安装包放入环境变量Gopath设置的目录/bin下面
protoc -version 检查是否安装成功
#### protoc-gen-go 
是protoc的一个go工具可以帮我们生成代码
$ go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.26
#### grpc安装
$ go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@v1.1
#### 安装Kratos
以下三种选其一
1. go get 安装
go get -u github.com/go-kratos/kratos/cmd/kratos/v2@latest
2. go install 安装
go install github.com/go-kratos/kratos/cmd/kratos/v2
go install github.com/go-kratos/kratos/cmd/kratos/v2@latest
3. 源码编译安装
git clone https://github.com/go-kratos/kratos
cd kratos
make install
#### 创建项目
kratos new realworld --创建项目
go mod download --下载依赖
##### 生成proto代码
创建proto模板
kratos proto add api/user/v1/user.proto
make api 根据对应需求make不同的命令
这时会生成对应的pb.go文件

##### MakeFile
###### 问题
make 提示不是内部命令？
安装MinGw,另外由于Kratos的MakeFile是按照Linux和MAC写的所以不能直接使用cmd。可以采用git的终端进行处理
### Docker
windows docker 无法启动 wsl 版本是1
https://docs.microsoft.com/zh-cn/windows/wsl/install-manual#step-4---download-the-linux-kernel-update-package
#### docker-compose
Compose 是用于定义和运行多容器 Docker 应用程序的工具。通过 Compose，您可以使用 YML 文件来配置应用程序需要的所有服务。然后，使用一个命令，就可以从 YML 文件配置中创建并启动所有服务。\
Compose 使用的三个步骤：\
. 使用 Dockerfile 定义应用程序的环境。\
. 使用 docker-compose.yml 定义构成应用程序的服务，这样它们可以在隔离环境中一起运行。\
. 最后，执行 docker-compose up 命令来启动并运行整个应用程序。
#### 项目开发步骤
##### api
通过定义Protoc 生成api接口
##### internal/service
创建realworld.go
```go
type RealworldService struct {
	v1.UnimplementedRealworldServer ---对外的Api

	uc  *biz.GreeterUsecase --内部业务逻辑
	log *log.Helper
}

// NewGreeterService new a greeter service.
func NewrealworldService(uc *biz.GreeterUsecase, logger log.Logger) *RealworldService {
	return &RealworldService{uc: uc, log: log.NewHelper(logger)}
}
```
service 修改依赖注入
```go
// ProviderSet is service providers.
var ProviderSet = wire.NewSet(NewrealworldService)
```
创建user --这个根据自身判断是否创建，这里用来测试接口是否成功
```go
//实现realworld-grpc.pb.go realworld_http.pb.go 接口
func (realworld *RealworldService ) Login(context.Context, *v1.LoginRequest)  (*v1.LoginReply, error) {
	userInfo:= v1.UserInfo{
		Email: "786797661@qq.com",
		Username: "yzc",
		Token:"",
	}
	return &v1.LoginReply{User: &userInfo},nil
}

```
##### 测试
http://127.0.0.1:8752/api/users/login
返回
```json
{
    "user": {
        "email": "786797661@qq.com",
        "token": "",
        "username": "yzc",
        "bio": "",
        "image": ""
    }
}
```
##### 文件结构

## 拓展
### docker
创建docker-compose
```xml
version: '3'
services:
  rwdb:
    image: mysql:8
    environment:
      MYSQL_ROOT_PASSWORD: dangerous
```
执行
```shell script
docker-compose up
```
###mysql

```shell
# mysql -u root -p //进入mysql
Enter password:   //输入密码
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 8
Server version: 8.0.28 MySQL Community Server - GPL

Copyright (c) 2000, 2022, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql> create database realowrld01; //创建数据库
Query OK, 1 row affected (0.02 sec)

mysql> show database;
ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'database' at line 1
mysql> show database;
ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'database' at line 1
mysql> show database;
ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'database' at line 1
mysql> show database
    -> ;
ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'database' at line 1
mysql> show databases; //展示
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| realowrld01        |
| sys                |
+--------------------+
5 rows in set (0.01 sec)
```
### Gorm
安装,驱动看自己数据库
```go
go get -u gorm.io/gorm
go get -u gorm.io/driver/mysql
```
#### Create
```go
user := User{Name: "Jinzhu", Age: 18, Birthday: time.Now()}

result := db.Create(&user) // pass pointer of data to Create

user.ID             // returns inserted data's primary key
result.Error        // returns error
result.RowsAffected // returns inserted records count
```
#### Create Record With Selected Fields
db.Select().Create()
创建一条数据并将指定值赋值
```go
db.Select("Name", "Age", "CreatedAt").Create(&user)
// INSERT INTO `users` (`name`,`age`,`created_at`) VALUES ("jinzhu", 18, "2020-07-04 11:05:21.775")

```
db.Omit().Create()
创建一条语句并不赋值指定数据
```go
db.Omit("Name", "Age", "CreatedAt").Create(&user)
// INSERT INTO `users` (`birthday`,`updated_at`) VALUES ("2020-01-01 00:00:00.000", "2020-07-04 11:05:21.775")

```
#### Batch Insert
通过切片保存
```go
var users = []User{{Name: "jinzhu1"}, {Name: "jinzhu2"}, {Name: "jinzhu3"}}
db.Create(&users)

for _, user := range users {
  user.ID // 1,2,3
}
```
通过CreateInBatches创建语句,并设置长度
```go
var users = []User{{Name: "jinzhu_1"}, ...., {Name: "jinzhu_10000"}}

// batch size 100
db.CreateInBatches(users, 100)
```
Gorm 创建时如果设置了CreateBatchSize，那么之后的保存都会按照这个配置
```go
db, err := gorm.Open(sqlite.Open("gorm.db"), &gorm.Config{
  CreateBatchSize: 1000,
})

db := db.Session(&gorm.Session{CreateBatchSize: 1000})

users = [5000]User{{Name: "jinzhu", Pets: []Pet{pet1, pet2, pet3}}...}

db.Create(&users)
// INSERT INTO users xxx (5 batches)
// INSERT INTO pets xxx (15 batches)
```
#### Create Hooks
GORM 允许用户定义钩子来实现 BeforeSave, BeforeCreate, AfterSave, AfterCreate。这些钩子方法将在创建一个记录时被调用
```go
func (u *User) BeforeCreate(tx *gorm.DB) (err error) {
  u.UUID = uuid.New()

  if u.Role == "admin" {
    return errors.New("invalid role")
  }
  return
}
```
如果你不想执行以下方法
```go
DB.Session(&gorm.Session{SkipHooks: true}).Create(&user)

DB.Session(&gorm.Session{SkipHooks: true}).Create(&users)

DB.Session(&gorm.Session{SkipHooks: true}).CreateInBatches(users, 100)

```

#### Create From Map
GORM支持从map[string]interface{}和[]map[string]interface{}{}创建
```go
db.Model(&User{}).Create(map[string]interface{}{
  "Name": "jinzhu", "Age": 18,
})

// batch insert from `[]map[string]interface{}{}`
db.Model(&User{}).Create([]map[string]interface{}{
  {"Name": "jinzhu_1", "Age": 18},
  {"Name": "jinzhu_2", "Age": 20},
})
```
#### Create From SQL Expression/Context Valuer
GORM允许用SQL表达式插入数据，有两种方法来实现这一目标，例如从map[string]interface{}或Customized Data Types创建。
```go
// Create from map
db.Model(User{}).Create(map[string]interface{}{
  "Name": "jinzhu",
  "Location": clause.Expr{SQL: "ST_PointFromText(?)", Vars: []interface{}{"POINT(100 100)"}},
})
// INSERT INTO `users` (`name`,`location`) VALUES ("jinzhu",ST_PointFromText("POINT(100 100)"));

// Create from customized data type
type Location struct {
  X, Y int
}

// Scan implements the sql.Scanner interface
func (loc *Location) Scan(v interface{}) error {
  // Scan a value into struct from database driver
}

func (loc Location) GormDataType() string {
  return "geometry"
}

func (loc Location) GormValue(ctx context.Context, db *gorm.DB) clause.Expr {
  return clause.Expr{
    SQL:  "ST_PointFromText(?)",
    Vars: []interface{}{fmt.Sprintf("POINT(%d %d)", loc.X, loc.Y)},
  }
}

type User struct {
  Name     string
  Location Location
}

db.Create(&User{
  Name:     "jinzhu",
  Location: Location{X: 100, Y: 100},
})
// INSERT INTO `users` (`name`,`location`) VALUES ("jinzhu",ST_PointFromText("POINT(100 100)"))

```
####Create With Associations
当创建一些有关联的数据时，如果其关联值不是零值，这些关联将被倒置，其Hooks方法将被调用。
CreditCard 是User的关联熟悉通过Creat时这个也会被创建
```go
type CreditCard struct {
  gorm.Model
  Number   string
  UserID   uint
}

type User struct {
  gorm.Model
  Name       string
  CreditCard CreditCard
}

db.Create(&User{
  Name: "jinzhu",
  CreditCard: CreditCard{Number: "411111111111"}
})
// INSERT INTO `users` ...
// INSERT INTO `credit_cards` ...
```
对于虚拟字段必须要设置默认值 
比如下面的FullName,可以带上(-)这个标签
```go
type User struct {
  ID        string `gorm:"default:uuid_generate_v3()"` // db func
  FirstName string
  LastName  string
  Age       uint8
  FullName  string `gorm:"->;type:GENERATED ALWAYS AS (concat(firstname,' ',lastname));default:(-);"`
}
```
### Query
#### where 条件拼接
```go
// Struct
db.Where(&User{Name: "jinzhu", Age: 20}).First(&user)
// SELECT * FROM users WHERE name = "jinzhu" AND age = 20 ORDER BY id LIMIT 1;

// Map
db.Where(map[string]interface{}{"name": "jinzhu", "age": 20}).Find(&users)
// SELECT * FROM users WHERE name = "jinzhu" AND age = 20;

// Slice of primary keys
db.Where([]int64{20, 21, 22}).Find(&users)
// SELECT * FROM users WHERE id IN (20, 21, 22);
db.Where("role = ?", "admin").Or("role = ?", "super_admin").Find(&users)
// SELECT * FROM users WHERE role = 'admin' OR role = 'super_admin';

// Struct
db.Where("name = 'jinzhu'").Or(User{Name: "jinzhu 2", Age: 18}).Find(&users)
// SELECT * FROM users WHERE name = 'jinzhu' OR (name = 'jinzhu 2' AND age = 18);

// Map
db.Where("name = 'jinzhu'").Or(map[string]interface{}{"name": "jinzhu 2", "age": 18}).Find(&users)
// SELECT * FROM users WHERE name = 'jinzhu' OR (name = 'jinzhu 2' AND age = 18);

```
#### Group By & Having
```go
type result struct {
  Date  time.Time
  Total int
}

db.Model(&User{}).Select("name, sum(age) as total").Where("name LIKE ?", "group%").Group("name").First(&result)
// SELECT name, sum(age) as total FROM `users` WHERE name LIKE "group%" GROUP BY `name` LIMIT 1


db.Model(&User{}).Select("name, sum(age) as total").Group("name").Having("name = ?", "group").Find(&result)
// SELECT name, sum(age) as total FROM `users` GROUP BY `name` HAVING name = "group"

rows, err := db.Table("orders").Select("date(created_at) as date, sum(amount) as total").Group("date(created_at)").Rows()
for rows.Next() {
  ...
}

rows, err := db.Table("orders").Select("date(created_at) as date, sum(amount) as total").Group("date(created_at)").Having("sum(amount) > ?", 100).Rows()
for rows.Next() {
  ...
}

type Result struct {
  Date  time.Time
  Total int64
}
db.Table("orders").Select("date(created_at) as date, sum(amount) as total").Group("date(created_at)").Having("sum(amount) > ?", 100).Scan(&results)
```
#### join
```go
type result struct {
  Name  string
  Email string
}

db.Model(&User{}).Select("users.name, emails.email").Joins("left join emails on emails.user_id = users.id").Scan(&result{})
// SELECT users.name, emails.email FROM `users` left join emails on emails.user_id = users.id

rows, err := db.Table("users").Select("users.name, emails.email").Joins("left join emails on emails.user_id = users.id").Rows()
for rows.Next() {
  ...
}

db.Table("users").Select("users.name, emails.email").Joins("left join emails on emails.user_id = users.id").Scan(&results)

// multiple joins with parameter
db.Joins("JOIN emails ON emails.user_id = users.id AND emails.email = ?", "jinzhu@example.org").Joins("JOIN credit_cards ON credit_cards.user_id = users.id").Where("credit_cards.number = ?", "411111111111").Find(&user)

```
#### Scan
可以将查询结果映射到对应结构体
```go
type Result struct {
  Name string
  Age  int
}

var result Result
db.Table("users").Select("name", "age").Where("name = ?", "Antonio").Scan(&result)

// Raw SQL
db.Raw("SELECT name, age FROM users WHERE name = ?", "Antonio").Scan(&result)
```

### Wire
GO 语言的依赖注入
1、安装
```go
go install github.com/google/wire/cmd/wire
```
2、使用
```go
wire //在指定文件夹下wire即可
也可已通过make wire 指令执行
```
### Git
推送新项目
create a new repository 

1、git init
2、git remote add origin https://github.com/786797661/knsh.git









